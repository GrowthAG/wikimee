---
// FeaturesCarousel - Carrossel seguindo referência exata do cliente
// Layout: Imagem esquerda (60%), texto direita (40%), setas < > embaixo, fundo preto

const base = import.meta.env.BASE_URL.replace(/\/$/, ''); // Remove trailing slash if exists

const features = [
  {
    id: 'kanban',
    title: 'Quadros Ágeis',
    description: 'Gerencie demandas com quadros Kanban personalizados. Organize por status, prioridade e responsável. Visualize todo o fluxo de trabalho da sua agência.',
    image: `${base}/screenshots/kanban.png`
  },
  {
    id: 'painel',
    title: 'Painel de Controle',
    description: 'Dashboard completo com métricas em tempo real. Acompanhe iniciativas, conteúdos, aprovações e demandas em um só lugar.',
    image: `${base}/screenshots/painel.png`
  },
  {
    id: 'mensagens',
    title: 'Comunicador',
    description: 'Centralize toda comunicação da agência. Mensagens, aprovações e feedback integrados diretamente nos projetos.',
    image: `${base}/screenshots/mensagens.png`
  },
  {
    id: 'versionamento',
    title: 'Versionamento',
    description: 'Controle total de versões e aprovações. Compare arquivos lado a lado e gerencie feedback em tempo real.',
    image: `${base}/screenshots/versionamento.png`
  },
  {
    id: 'portal',
    title: 'Portal do Cliente',
    description: 'Crie portais personalizados para cada cliente. Workspaces, kanbans e pastas organizados com a identidade da sua agência.',
    image: `${base}/screenshots/portal.png`
  },
  {
    id: 'workspaces',
    title: 'Workspaces',
    description: 'Ambientes completos por cliente ou projeto. Campanhas, conteúdos, demandas e equipes organizados visualmente.',
    image: `${base}/screenshots/workspaces.png`
  }
];
---

<section class="carousel-section" id="features">
  <div class="carousel-container">
    <div class="carousel-viewport">
      <div class="carousel-track" id="carouselTrack">
        <!-- Clone do último slide para loop infinito -->
        <div class="carousel-slide" data-clone="last">
          <div class="slide-image">
            <img src={features[features.length - 1].image} alt={features[features.length - 1].title} loading="lazy" />
          </div>
          <div class="slide-content">
            <p class="slide-quote">"{features[features.length - 1].description}"</p>
            <div class="slide-author">
              <span class="author-name">{features[features.length - 1].title}</span>
              <span class="author-role">WIKIMEE</span>
            </div>
            <div class="slide-nav">
              <button class="nav-btn nav-prev" aria-label="Anterior"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7" /></svg></button>
              <button class="nav-btn nav-next" aria-label="Próximo"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7" /></svg></button>
            </div>
          </div>
        </div>

        {features.map((feature, index) => (
          <div class="carousel-slide" data-index={index}>
            <div class="slide-image">
              <img src={feature.image} alt={feature.title} loading={index === 0 ? "eager" : "lazy"} />
            </div>
            <div class="slide-content">
              <p class="slide-quote">"{feature.description}"</p>
              <div class="slide-author">
                <span class="author-name">{feature.title}</span>
                <span class="author-role">WIKIMEE</span>
              </div>
              <div class="slide-nav">
                <button class="nav-btn nav-prev" aria-label="Anterior"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7" /></svg></button>
                <button class="nav-btn nav-next" aria-label="Próximo"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7" /></svg></button>
              </div>
            </div>
          </div>
        ))}

        <!-- Clone do primeiro slide para loop infinito -->
        <div class="carousel-slide" data-clone="first">
          <div class="slide-image">
            <img src={features[0].image} alt={features[0].title} loading="lazy" />
          </div>
          <div class="slide-content">
            <p class="slide-quote">"{features[0].description}"</p>
            <div class="slide-author">
              <span class="author-name">{features[0].title}</span>
              <span class="author-role">WIKIMEE</span>
            </div>
            <div class="slide-nav">
              <button class="nav-btn nav-prev" aria-label="Anterior"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7" /></svg></button>
              <button class="nav-btn nav-next" aria-label="Próximo"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7" /></svg></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .carousel-section {
    background: #000000;
    padding: 4rem 0;
    width: 100%;
  }

  .carousel-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .carousel-viewport {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 0.5rem;
  }

  .carousel-track {
    display: flex;
    width: 100%;
    /* Transition is managed by JS */
  }

  .carousel-slide {
    flex: 0 0 100%;
    width: 100%;
    min-width: 100%;
    display: flex;
    flex-direction: column;
    background: #000000;
  }

  @media (min-width: 768px) {
    .carousel-slide {
      flex-direction: row;
    }
  }

  .slide-image {
    width: 100%;
    background: #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  @media (min-width: 768px) {
    .slide-image {
      width: 60%;
    }
  }

  .slide-image img {
    width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: contain;
    object-position: center;
  }

  .slide-content {
    width: 100%;
    padding: 2rem;
    background: #000000;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  @media (min-width: 768px) {
    .slide-content {
      width: 40%;
      padding: 3rem;
    }
  }

  .slide-quote {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
    line-height: 1.7;
    font-style: italic;
    margin-bottom: 2rem;
  }

  .slide-author {
    margin-bottom: 2rem;
  }

  .author-name {
    display: block;
    color: #ffffff;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }

  .author-role {
    display: block;
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .slide-nav {
    display: flex;
    gap: 0.5rem;
  }

  .nav-btn {
    width: 40px;
    height: 40px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: transparent;
    color: rgba(255, 255, 255, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .nav-btn:hover {
    border-color: rgba(255, 255, 255, 0.4);
    color: #ffffff;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('carouselTrack');
    if (!track) return;
    
    // Select all slides including clones
    // Note: track.children updates live, but we can iterate comfortably
    const slides = Array.from(track.children);
    const totalSlides = slides.length; 
    
    // Logic:
    // Index 0: Clone of LAST
    // Index 1: First Real Slide
    // ...
    // Index N-2: Last Real Slide
    // Index N-1: Clone of FIRST
    
    // Start at Index 1 (First Real Slide)
    let currentIndex = 1;
    let autoplayInterval: ReturnType<typeof setInterval>;
    let isTransitioning = false;
    
    // Initialize position directly to slide 1 without transition
    track.style.transform = `translateX(-100%)`;
    
    function updateSlide(index: number, withTransition = true) {
      if (withTransition) {
        track.style.transition = 'transform 0.5s ease-in-out';
        isTransitioning = true;
      } else {
        track.style.transition = 'none';
        isTransitioning = false;
      }
      
      currentIndex = index;
      track.style.transform = `translateX(-${currentIndex * 100}%)`;
    }
    
    // Handle transition end to detect if we need to jump (teleport)
    track.addEventListener('transitionend', () => {
      isTransitioning = false;
      
      // If we are at the clone of the first slide (last index), jump to real first (index 1)
      if (currentIndex === totalSlides - 1) {
        updateSlide(1, false);
      }
      // If we are at the clone of the last slide (index 0), jump to real last (index N-2)
      else if (currentIndex === 0) {
        updateSlide(totalSlides - 2, false);
      }
    });

    function nextSlide() {
      if (isTransitioning) return;
      updateSlide(currentIndex + 1);
    }
    
    function prevSlide() {
      if (isTransitioning) return;
      updateSlide(currentIndex - 1);
    }
    
    function startAutoplay() {
      stopAutoplay();
      autoplayInterval = setInterval(nextSlide, 5000);
    }
    
    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
      }
    }
    
    // Attach event listeners to all nav buttons
    document.querySelectorAll('.nav-prev').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        prevSlide();
        startAutoplay();
      });
    });
    
    document.querySelectorAll('.nav-next').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        nextSlide();
        startAutoplay();
      });
    });
    
    // Touch support
    let touchStartX = 0;
    
    track.addEventListener('touchstart', (e: TouchEvent) => {
      touchStartX = e.touches[0].clientX;
      stopAutoplay();
    }, { passive: true });
    
    track.addEventListener('touchend', (e: TouchEvent) => {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > 50) {
        if (diff > 0) nextSlide();
        else prevSlide();
      }
      startAutoplay();
    }, { passive: true });
    
    // Pause on hover
    const viewport = document.querySelector('.carousel-viewport');
    viewport?.addEventListener('mouseenter', stopAutoplay);
    viewport?.addEventListener('mouseleave', startAutoplay);
    
    // Start autoplay
    startAutoplay();
  });
</script>
